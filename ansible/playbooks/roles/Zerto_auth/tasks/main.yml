---

- name: Get Zerto Alarms
  ansible.builtin.uri:
    url: "https://analytics.api.zerto.com/v2/monitoring/alerts"
    method: GET
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{ token }}"
    validate_certs: false
    force_basic_auth: yes
    return_content: true
  register: login

- name: Filter alarms with type VPG0010
  set_fact:
    filtered_alarms: "{{ login.json | json_query('[?type==`VPG0010`]') }}"

- name: Ensure filtered_alarms is set
  debug:
    var: filtered_alarms

- name: Format filtered alarms
  set_fact:
    formatted_alarms: >-
      {{
        filtered_alarms | map('extract',
          {
            'Issue appeared on': 'collectionTime',
            'Alarm ID': 'type',
            'Severity': 'severity',
            'Description': 'description',
            'Location': 'site.name'
          }) | map('dict2items') | map('map', 'join', ': ') | map('join', '\n') | join('\n\n')
      }}

- name: Print formatted alarms
  debug:
    var: formatted_alarms

- name: Write results to file
  copy:
    content: '{{ formatted_alarms }}'
    dest: '~/alarms.txt'
  delegate_to: 172.16.101.183
